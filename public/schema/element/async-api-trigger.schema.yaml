$id: http://qubership.org/schemas/product/qip/element/async-api-trigger.schema.yaml
$schema: http://json-schema.org/draft-07/schema
type: object
allOf:
  - type: object
    allOf:
      - type: object
        title: Common Entity Properties
        properties:
          id:
            type: string
            title: Identifier
          name:
            type: string
            title: Name
        required:
          - id
          - name
      - type: object
        title: Entity with description
        properties:
          description:
            type: string
            title: Description
      - type: object
        properties:
          swimlaneId:
            type: string
title: AsyncAPI Trigger
description: Receives a call from a service registered in API Repository
properties:
  type:
    type: string
    const: async-api-trigger
  properties:
    type: object
    allOf:
      - $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Idempotency properties
        properties:
          idempotency:
            allOf:
              - &ref_1
                type: object
                properties:
                  enabled:
                    type: boolean
                    title: Enable idempotency
                    default: false
                  keyExpiry:
                    allOf:
                      - &ref_0
                        oneOf:
                          - type: integer
                            minimum: 0
                          - type: string
                            pattern: ^[0-9]+$
                          - type: string
                            pattern: ^#\{[a-zA-Z0-9:._-]+\}$
                    title: Key expiration time (seconds)
                    default: 600
                  contextExpression:
                    type: string
                    title: Context expression
                  keyExpression:
                    type: string
                    title: Key expression
                  actionOnDuplicate:
                    enum:
                      - ignore
                      - throw-exception
                      - execute-subchain
                    title: Action on duplicate message
                    default: ignore
                if:
                  properties:
                    enabled:
                      const: true
                then:
                  required:
                    - contextExpression
                    - keyExpression
            if:
              properties:
                enabled:
                  const: true
                actionOnDuplicate:
                  const: execute-subchain
              required:
                - enabled
                - actionOnDuplicate
            then:
              allOf:
                - &ref_2
                  type: object
                  properties:
                    chainTriggerParameters:
                      title: Subchain execution parameters
                      type: object
                      additionalProperties: false
                      properties: &ref_3
                        triggerElementId:
                          type: string
                          title: Chain trigger
                        chainCallTimeout:
                          allOf:
                            - *ref_0
                          title: Timeout (ms)
                          default: 30000
                      required: &ref_4
                        - triggerElementId
                  required:
                    - chainTriggerParameters
        definitions:
          CommonIdempotencyProperties: *ref_1
          ExecuteSubchainProperties: *ref_2
          ChainTriggerParameters:
            type: object
            title: Subchain execution parameters
            additionalProperties: false
            properties: *ref_3
            required: *ref_4
    properties:
      after:
        type: array
        title: Request validation schemas
        items: &ref_5
          type: object
          properties:
            code:
              type: string
            label:
              type: string
          additionalProperties: false
          required:
            - code
            - label
            - schema
      asyncValidationSchema:
        type: string
        title: Response validation schema
      requestFilterHeaderAllowlist:
        title: Filtered headers list
        $schema: http://json-schema.org/draft-07/schema
        type: object
        patternProperties:
          ^.+$:
            type: string
      integrationOperationId:
        type: string
        title: Operation ID
      integrationSpecificationGroupId:
        type: string
        title: Specification group ID
      integrationSpecificationId:
        type: string
        title: Specification ID
      integrationSystemId:
        type: string
        title: Service ID
      systemType:
        title: Service type
        enum:
          - INTERNAL
          - EXTERNAL
          - IMPLEMENTED
      integrationOperationProtocolType:
        title: Operation protocol type
        enum: &ref_6
          - kafka
          - amqp
      integrationOperationMethod:
        title: Operation method
        enum: &ref_7
          - subscribe
          - publish
      integrationOperationPath:
        type: string
        title: Operation name
    if:
      properties:
        integrationOperationProtocolType:
          const: kafka
    then:
      properties:
        reconnectDelay:
          allOf:
            - *ref_0
          title: Reconnection delay (ms)
          default: 30000
        integrationOperationAsyncProperties: &ref_8
          type: object
          additionalProperties: true
    else:
      properties:
        integrationOperationAsyncProperties: &ref_9
          type: object
          properties:
            acknowledgeMode: &ref_10
              enum:
                - NONE
                - MANUAL
                - AUTO
          additionalProperties: true
definitions:
  RequestValidation: *ref_5
  Protocol:
    enum: *ref_6
  Method:
    enum: *ref_7
  KafkaProperties: *ref_8
  AmqpProperties: *ref_9
  AcknowledgeMode: *ref_10
required:
  - type
