$id: http://qubership.org/schemas/product/qip/element/service-call.schema.yaml
$schema: http://json-schema.org/draft-07/schema
type: object
allOf:
  - type: object
    title: Common Entity Properties
    properties:
      id:
        type: string
        title: Identifier
      name:
        type: string
        title: Name
    required:
      - id
      - name
  - type: object
    title: Entity with description
    properties:
      description:
        type: string
        title: Description
title: Service Call
description: Make a call to a service registered in API Repository.
properties:
  type:
    type: string
    const: service-call
  properties:
    type: object
    allOf:
      - $id: >-
          http://qubership.org/schemas/product/qip/element/properties/operation.schema.yaml
        $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Operation properties
        oneOf:
          - type: object
            properties:
              integrationOperationProtocolType:
                const: kafka
              integrationOperationMethod:
                title: Operation method
                enum: &ref_0
                  - subscribe
                  - publish
              integrationOperationAsyncProperties:
                type: object
                additionalProperties: true
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            properties:
              integrationOperationProtocolType:
                const: amqp
              integrationOperationMethod:
                title: Operation method
                enum: *ref_0
              integrationOperationAsyncProperties:
                type: object
                additionalProperties: true
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            oneOf:
              - type: object
                properties:
                  integrationOperationProtocolType:
                    const: http
              - type: object
                properties:
                  integrationOperationProtocolType:
                    const: soap
            properties:
              integrationOperationMethod:
                title: Operation method
                enum: &ref_2
                  - POST
                  - GET
                  - PUT
                  - DELETE
                  - PATCH
                  - HEAD
                  - OPTIONS
              integrationOperationPathParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              integrationOperationQueryParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              integrationAdditionalParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              bodyMimeType:
                type: string
              bodyFormData:
                type: array
                items:
                  type: object
                  properties:
                    fieldName:
                      type: string
                    mimeType:
                      type: string
                    name:
                      type: string
                    value:
                      type: string
                    fileName:
                      type: string
                  required:
                    - mimeType
                    - name
                    - value
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            properties:
              integrationOperationProtocolType:
                const: graphql
              integrationGqlOperationName:
                type: string
                title: Operation Name
                description: >
                  The query or mutation name. Optional if query contains single
                  operation.
              integrationGqlQuery:
                type: string
                title: Query
                description: The query text.
              integrationGqlQueryHeader:
                type: string
                default: CamelGraphQLQuery
                title: Query header
              integrationGqlVariablesHeader:
                type: string
                default: CamelGraphQLVariables
                title: Variables header
              integrationGqlVariablesJSON:
                type: string
                title: Variables JSON
                description: Operation variables in JSON format.
            required:
              - integrationOperationProtocolType
              - integrationGqlQuery
        properties:
          integrationOperationId:
            type: string
            title: Operation ID
          integrationSpecificationGroupId:
            type: string
            title: Specification group ID
          integrationSpecificationId:
            type: string
            title: Specification ID
          integrationSystemId:
            type: string
            title: Service ID
          systemType:
            title: Service type
            enum:
              - INTERNAL
              - EXTERNAL
              - IMPLEMENTED
          integrationOperationProtocolType:
            title: Operation protocol type
            enum: &ref_1
              - http
              - kafka
              - amqp
              - graphql
              - grpc
              - soap
          integrationOperationMethod:
            title: Operation method
          integrationOperationPath:
            type: string
            title: Operation name
        required:
          - integrationOperationId
          - integrationSpecificationGroupId
          - integrationSpecificationId
          - integrationSystemId
          - systemType
          - integrationOperationProtocolType
          - integrationOperationPath
          - integrationOperationMethod
        definitions:
          Protocol:
            enum: *ref_1
          HttpMethod:
            enum: *ref_2
          AsyncMethod:
            enum: *ref_0
      - $id: >-
          http://qubership.org/schemas/product/qip/element/properties/correlation-id.schema.yaml
        $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Correlation ID properties
        properties:
          receiveCorrelationId:
            type: boolean
            title: Receive correlation ID
            default: false
        if:
          properties:
            receiveCorrelationId:
              const: true
          required:
            - receiveCorrelationId
        then:
          allOf:
            - &ref_3
              type: object
              properties:
                correlationIdPosition:
                  title: Correlation ID position
                  enum: &ref_4
                    - header
                    - body
                correlationIdName:
                  type: string
                  title: Correlation ID name
              required:
                - correlationIdPosition
                - correlationIdName
        else:
          if:
            required:
              - correlationIdPosition
          then:
            allOf:
              - *ref_3
          else:
            if:
              required:
                - correlationIdName
            then:
              allOf:
                - *ref_3
        definitions:
          CorrelationIdPosition:
            enum: *ref_4
          CorrelationIdProperties: *ref_3
      - $id: >-
          http://qubership.org/schemas/product/qip/element/properties/context-propagation.schema.yaml
        $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Context propagation properties
        properties:
          propagateContext:
            type: boolean
            title: Propagate context
            description: Propagate context to headers before sending message.
            default: true
          overrideContextParams:
            title: Override technical context headers
            description: Propagate props to headers before sending message.
            $id: >-
              http://qubership.org/schemas/product/qip/element/properties/headers.schema.yaml
            $schema: http://json-schema.org/draft-07/schema
            type: object
            patternProperties:
              ^.+$:
                type: string
      - &ref_24
        type: object
        properties:
          handleValidationAction:
            type: string
            enum:
              - default
              - script
              - mapper-2
            default: default
        if:
          properties:
            handleValidationAction:
              const: script
          required:
            - handleValidationAction
        then:
          properties:
            handlerContainer: &ref_17
              allOf:
                - &ref_5
                  $id: >-
                    http://qubership.org/schemas/product/qip/element/properties/properties-in-external-file.schema.yaml
                  $schema: http://json-schema.org/draft-07/schema
                  type: object
                  title: Schema for element properties in external file
                  properties:
                    exportFileExtension:
                      type: string
                      description: Specifies file extension of exported properties
                    propertiesToExportInSeparateFile:
                      type: string
                      description: >-
                        Specifies list of properties to be exported is separate
                        file
                    propertiesFilename:
                      $id: >-
                        http://qubership.org/schemas/product/qip/resource-reference.schema.yaml
                      $schema: http://json-schema.org/draft-07/schema
                      type: string
                      title: Resource reference
                - type: object
                  properties:
                    script:
                      type: string
                      title: Script
          required:
            - handlerContainer
        else:
          if:
            properties:
              handleValidationAction:
                const: mapper-2
            required:
              - handleValidationAction
          then:
            properties:
              handlerContainer: &ref_16
                type: object
                allOf:
                  - *ref_5
                  - type: object
                    properties:
                      throwException:
                        type: boolean
                        title: Throw exception on transformation failure
                        description: Throw exception on transformation failure.
                        default: true
                      mappingDescription:
                        type: object
                        allOf:
                          - &ref_6
                            type: object
                            title: Object with metadata
                            properties:
                              metadata:
                                type: object
                                title: Metadata
                                patternProperties:
                                  ^.+$:
                                    type: string
                        properties:
                          source: &ref_11
                            type: object
                            allOf:
                              - *ref_6
                            properties:
                              headers:
                                type: array
                                title: Headers
                                items: &ref_9
                                  type: object
                                  allOf:
                                    - &ref_12
                                      type: object
                                      allOf:
                                        - *ref_6
                                      properties:
                                        id:
                                          type: string
                                        name:
                                          type: string
                                        type: &ref_7
                                          type: object
                                          oneOf:
                                            - type: object
                                              allOf:
                                                - *ref_6
                                              properties:
                                                name:
                                                  const: null
                                            - type: object
                                              allOf:
                                                - *ref_6
                                              properties:
                                                name:
                                                  const: string
                                            - type: object
                                              allOf:
                                                - *ref_6
                                              properties:
                                                name:
                                                  const: number
                                            - type: object
                                              allOf:
                                                - *ref_6
                                              properties:
                                                name:
                                                  const: boolean
                                            - type: object
                                              allOf:
                                                - *ref_6
                                                - &ref_8
                                                  type: object
                                                  properties:
                                                    definitions:
                                                      type: array
                                                      items:
                                                        type: object
                                                        properties:
                                                          id:
                                                            type: string
                                                          name:
                                                            type: string
                                                          type: *ref_7
                                                        required:
                                                          - id
                                                          - name
                                                          - type
                                              properties:
                                                name:
                                                  const: array
                                                itemType: *ref_7
                                            - type: object
                                              allOf:
                                                - *ref_6
                                                - *ref_8
                                              properties:
                                                name:
                                                  const: object
                                                schema:
                                                  type: object
                                                  allOf:
                                                    - *ref_6
                                                  properties:
                                                    id:
                                                      type: string
                                                    attributes:
                                                      type: array
                                                      items: *ref_9
                                            - type: object
                                              allOf:
                                                - *ref_6
                                                - *ref_8
                                              properties:
                                                name:
                                                  const: reference
                                                definitionId:
                                                  type: string
                                            - type: object
                                              allOf:
                                                - &ref_10
                                                  type: object
                                                  allOf:
                                                    - *ref_6
                                                    - *ref_8
                                                  properties:
                                                    types:
                                                      type: array
                                                      items: *ref_7
                                              properties:
                                                name:
                                                  const: allOf
                                            - type: object
                                              allOf:
                                                - *ref_10
                                              properties:
                                                name:
                                                  const: anyOf
                                            - type: object
                                              allOf:
                                                - *ref_10
                                              properties:
                                                name:
                                                  const: oneOf
                                      required:
                                        - id
                                        - type
                                        - name
                                  properties:
                                    defaultValue:
                                      type: string
                                    required:
                                      type: boolean
                                      default: false
                              properties:
                                type: array
                                title: Properties
                                items: *ref_9
                              body:
                                oneOf:
                                  - *ref_7
                                  - type: 'null'
                          target: *ref_11
                          constants:
                            type: array
                            title: Constants
                            items:
                              type: object
                              allOf:
                                - *ref_12
                              properties:
                                valueSupplier:
                                  type: object
                                  oneOf:
                                    - type: object
                                      allOf:
                                        - *ref_6
                                      properties:
                                        kind:
                                          const: given
                                        value:
                                          type: string
                                      required:
                                        - kind
                                        - value
                                    - type: object
                                      allOf:
                                        - *ref_6
                                      properties:
                                        kind:
                                          const: generated
                                        generator:
                                          type: object
                                          allOf:
                                            - *ref_6
                                          properties:
                                            name:
                                              type: string
                                            parameters:
                                              type: array
                                              items:
                                                type: string
                                          required:
                                            - name
                                      required:
                                        - kind
                                        - generator
                          actions:
                            type: array
                            title: Actions
                            items:
                              type: object
                              allOf:
                                - *ref_6
                              title: Mapping action
                              properties:
                                id:
                                  type: string
                                sources:
                                  type: array
                                  title: Sources
                                  items:
                                    type: object
                                    oneOf:
                                      - type: object
                                        allOf:
                                          - *ref_6
                                        properties:
                                          type:
                                            const: constant
                                          constantId:
                                            type: string
                                      - &ref_13
                                        type: object
                                        allOf:
                                          - *ref_6
                                        properties:
                                          type:
                                            const: attribute
                                          kind:
                                            enum:
                                              - header
                                              - property
                                              - body
                                          path:
                                            type: array
                                            title: Path
                                            items:
                                              type: string
                                target: *ref_13
                                transformation:
                                  type: object
                                  allOf:
                                    - *ref_6
                                  properties:
                                    name:
                                      type: string
                                      title: Name
                                    parameters:
                                      type: array
                                      title: Parameters
                                      items:
                                        type: string
                                  required:
                                    - name
                              required:
                                - id
                                - sources
                                - target
            required:
              - handlerContainer
    properties:
      errorThrowing:
        type: boolean
      retryCount:
        oneOf:
          - &ref_14
            oneOf:
              - type: integer
                minimum: 0
              - type: string
                pattern: ^[0-9]+$
              - type: string
                pattern: ^#\{[a-zA-Z0-9:._-]+\}$
          - &ref_15
            type: string
            pattern: \$\{[^}]+\}
        default: 0
        title: Retry count
        description: >
          Specifies number of retries for the call before it considers as
          failed.
      retryDelay:
        oneOf:
          - *ref_14
          - *ref_15
        default: 5000
        title: Retry delay (ms)
        description: Specifies delay between retries in millis.
      before: &ref_18
        oneOf:
          - type: object
            allOf:
              - *ref_16
            properties:
              type:
                const: mapper-2
            required:
              - type
          - type: object
            allOf:
              - *ref_17
            properties:
              type:
                const: script
            required:
              - type
      after:
        type: array
        items: &ref_25
          type: object
          anyOf:
            - *ref_18
            - not:
                type: object
                properties:
                  type:
                    enum:
                      - script
                      - mapper-2
                required:
                  - type
          properties:
            id:
              type: string
            code:
              type: string
            label:
              type: string
            wildcard:
              type: boolean
      authorizationConfiguration:
        oneOf:
          - &ref_19
            type: object
            properties:
              type:
                const: none
          - &ref_20
            type: object
            properties:
              type:
                const: basic
              data:
                type: object
                properties:
                  username:
                    type: string
                  password:
                    type: string
                required:
                  - username
                  - password
          - &ref_21
            type: object
            properties:
              type:
                const: bearer
              data:
                type: object
                properties:
                  token:
                    type: string
                required:
                  - token
          - &ref_22
            type: object
            properties:
              type:
                const: m2m
    required:
      - retryCount
      - retryDelay
    if:
      properties:
        integrationOperationProtocolType:
          const: http
    then:
      properties:
        afterValidation:
          type: array
          items: &ref_23
            type: object
            properties:
              code:
                type: string
              contentType:
                type: string
              id:
                type: string
              label:
                type: string
              schema:
                type: string
              type:
                const: responseValidation
definitions:
  AuthorizationNone: *ref_19
  AuthorizationBasic: *ref_20
  AuthorizationBearerToken: *ref_21
  AuthorizationM2MToken: *ref_22
  ResponseValidation: *ref_23
  ExchangeTransformation: *ref_18
  ValidationFailureHandler: *ref_24
  ResponseHandler: *ref_25
