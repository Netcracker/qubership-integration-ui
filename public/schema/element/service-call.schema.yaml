$id: http://qubership.org/schemas/product/qip/element/service-call.schema.yaml
$schema: http://json-schema.org/draft-07/schema
type: object
allOf:
  - type: object
    allOf:
      - type: object
        title: Common Entity Properties
        properties:
          id:
            type: string
            title: Identifier
          name:
            type: string
            title: Name
        required:
          - id
          - name
      - type: object
        title: Entity with description
        properties:
          description:
            type: string
            title: Description
      - type: object
        properties:
          swimlaneId:
            type: string
title: Service Call
description: Make a call to a service registered in API Repository.
properties:
  type:
    type: string
    const: service-call
  properties:
    type: object
    allOf:
      - $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Operation properties
        oneOf:
          - type: object
            properties:
              integrationOperationProtocolType:
                const: kafka
              integrationOperationMethod:
                title: Operation method
                enum: &ref_0
                  - subscribe
                  - publish
              integrationOperationAsyncProperties:
                type: object
                additionalProperties: true
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            properties:
              integrationOperationProtocolType:
                const: amqp
              integrationOperationMethod:
                title: Operation method
                enum: *ref_0
              integrationOperationAsyncProperties:
                type: object
                additionalProperties: true
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            oneOf:
              - type: object
                properties:
                  integrationOperationProtocolType:
                    const: http
              - type: object
                properties:
                  integrationOperationProtocolType:
                    const: soap
            properties:
              integrationOperationMethod:
                title: Operation method
                enum: &ref_2
                  - POST
                  - GET
                  - PUT
                  - DELETE
                  - PATCH
                  - HEAD
                  - OPTIONS
              integrationOperationPathParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              integrationOperationQueryParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              integrationAdditionalParameters:
                type: object
                patternProperties:
                  ^.*$:
                    type: string
              bodyMimeType:
                type: string
              bodyFormData:
                type: array
                items:
                  type: object
                  properties:
                    fieldName:
                      type: string
                    mimeType:
                      type: string
                    name:
                      type: string
                    value:
                      type: string
                    fileName:
                      type: string
                  required:
                    - mimeType
                    - name
                    - value
            required:
              - integrationOperationProtocolType
              - integrationOperationMethod
          - type: object
            properties:
              integrationOperationProtocolType:
                const: graphql
              integrationGqlOperationName:
                type: string
                title: Operation Name
                description: >
                  The query or mutation name. Optional if query contains single
                  operation.
              integrationGqlQuery:
                type: string
                title: Query
                description: The query text.
              integrationGqlQueryHeader:
                type: string
                default: CamelGraphQLQuery
                title: Query header
              integrationGqlVariablesHeader:
                type: string
                default: CamelGraphQLVariables
                title: Variables header
              integrationGqlVariablesJSON:
                type: string
                title: Variables JSON
                description: Operation variables in JSON format.
            required:
              - integrationOperationProtocolType
              - integrationGqlQuery
        properties:
          integrationOperationId:
            type: string
            title: Operation ID
          integrationSpecificationGroupId:
            type: string
            title: Specification group ID
          integrationSpecificationId:
            type: string
            title: Specification ID
          integrationSystemId:
            type: string
            title: Service ID
          systemType:
            title: Service type
            enum:
              - INTERNAL
              - EXTERNAL
              - IMPLEMENTED
          integrationOperationProtocolType:
            title: Operation protocol type
            enum: &ref_1
              - http
              - kafka
              - amqp
              - graphql
              - grpc
              - soap
          integrationOperationMethod:
            title: Operation method
          integrationOperationPath:
            type: string
            title: Operation name
        required:
          - integrationOperationId
          - integrationSpecificationGroupId
          - integrationSpecificationId
          - integrationSystemId
          - systemType
          - integrationOperationProtocolType
          - integrationOperationPath
          - integrationOperationMethod
        definitions:
          Protocol:
            enum: *ref_1
          HttpMethod:
            enum: *ref_2
          AsyncMethod:
            enum: *ref_0
      - $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Correlation ID properties
        properties:
          receiveCorrelationId:
            type: boolean
            title: Receive correlation ID
            default: false
        if:
          properties:
            receiveCorrelationId:
              const: true
          required:
            - receiveCorrelationId
        then:
          allOf:
            - &ref_4
              type: object
              properties:
                correlationIdPosition:
                  title: Correlation ID position
                  enum: &ref_3
                    - header
                    - body
                correlationIdName:
                  type: string
                  title: Correlation ID name
              required:
                - correlationIdPosition
                - correlationIdName
        definitions:
          CorrelationIdPosition:
            enum: *ref_3
          CorrelationIdProperties: *ref_4
      - $schema: http://json-schema.org/draft-07/schema
        type: object
        title: Context propagation properties
        properties:
          propagateContext:
            type: boolean
            title: Propagate context
            description: Propagate context to headers before sending message.
            default: true
          overrideContextParams:
            title: Override technical context headers
            description: Propagate props to headers before sending message.
            $schema: http://json-schema.org/draft-07/schema
            type: object
            patternProperties:
              ^.+$:
                type: string
      - &ref_15
        type: object
        properties:
          handleValidationAction:
            type: string
            enum:
              - default
              - script
              - mapper-2
            default: default
        if:
          properties:
            handleValidationAction:
              const: script
          required:
            - handleValidationAction
        then:
          properties:
            handlerContainer: &ref_8
              type: object
              properties:
                exportFileExtension:
                  type: string
                  const: groovy
                propertiesToExportInSeparateFile:
                  type: string
                  const: script
                propertiesFilename:
                  type: string
                  title: Script resource reference
                script:
                  type: string
                  title: Script
          required:
            - handlerContainer
        else:
          if:
            properties:
              handleValidationAction:
                const: mapper-2
            required:
              - handleValidationAction
          then:
            properties:
              handlerContainer: &ref_7
                type: object
                properties:
                  exportFileExtension:
                    type: string
                    const: json
                  propertiesToExportInSeparateFile:
                    type: string
                    const: mappingDescription
                  propertiesFilename:
                    type: string
                    title: Mapper resource reference
                  throwException:
                    type: boolean
                    title: Throw exception on transformation failure
                    description: Throw exception on transformation failure.
                    default: true
                  mappingDescription:
                    type: object
            required:
              - handlerContainer
    properties:
      errorThrowing:
        type: boolean
      retryCount:
        oneOf:
          - &ref_5
            oneOf:
              - type: integer
                minimum: 0
              - type: string
                pattern: ^[0-9]+$
              - type: string
                pattern: ^#\{[a-zA-Z0-9:._-]+\}$
          - &ref_6
            type: string
            pattern: \$\{[^}]+\}
        default: 0
        title: Retry count
        description: >
          Specifies number of retries for the call before it considers as
          failed.
      retryDelay:
        oneOf:
          - *ref_5
          - *ref_6
        default: 5000
        title: Retry delay (ms)
        description: Specifies delay between retries in millis.
      before: &ref_9
        oneOf:
          - type: object
            allOf:
              - *ref_7
            properties:
              type:
                const: mapper-2
            required:
              - type
          - type: object
            allOf:
              - *ref_8
            properties:
              type:
                const: script
            required:
              - type
      after:
        type: array
        items: &ref_16
          type: object
          anyOf:
            - *ref_9
            - not:
                type: object
                properties:
                  type:
                    enum:
                      - script
                      - mapper-2
                required:
                  - type
          properties:
            id:
              type: string
            code:
              type: string
            label:
              type: string
            wildcard:
              type: boolean
      authorizationConfiguration:
        oneOf:
          - &ref_10
            type: object
            properties:
              type:
                const: none
          - &ref_11
            type: object
            properties:
              type:
                const: basic
              data:
                type: object
                properties:
                  username:
                    type: string
                  password:
                    type: string
                required:
                  - username
                  - password
          - &ref_12
            type: object
            properties:
              type:
                const: bearer
              data:
                type: object
                properties:
                  token:
                    type: string
                required:
                  - token
          - &ref_13
            type: object
            properties:
              type:
                const: m2m
    required:
      - retryCount
      - retryDelay
    if:
      properties:
        integrationOperationProtocolType:
          const: http
    then:
      properties:
        afterValidation:
          type: array
          items: &ref_14
            type: object
            properties:
              code:
                type: string
              contentType:
                type: string
              id:
                type: string
              label:
                type: string
              schema:
                type: string
              type:
                const: responseValidation
definitions:
  AuthorizationNone: *ref_10
  AuthorizationBasic: *ref_11
  AuthorizationBearerToken: *ref_12
  AuthorizationM2MToken: *ref_13
  ResponseValidation: *ref_14
  ExchangeTransformation: *ref_9
  ValidationFailureHandler: *ref_15
  ResponseHandler: *ref_16
required:
  - type
